---
layout: post
title: "Windows Service Project - Where it Ended Up"
date: 2012-09-03 09:00
author: lotsofgigs
comments: true
categories: [software]
tags: [C#, jeremy, software, Windows Service]
---
This is the second part of a multi-part series.  Links to other posts are listed after the article.

I kept with the same basic concept from before, a [FileSystemWatcher](http://msdn.microsoft.com/en-us/library/system.io.filesystemwatcher.aspx) that has a [Created](http://msdn.microsoft.com/en-us/library/system.io.filesystemwatcher.created) event that calls a public method in a class library.  The big change between the first version and the third version of this application is how we are getting the data from the third party.  They were initially sending a very complex excel document with inconsistent formatting and I got them to send two [CSV](http://en.wikipedia.org/wiki/Comma-separated_values) files containing the same information.  I made this decision because the reporting requirements changed *drastically* between these versions.    Basically it went from no reporting to a lot of reporting and they wanted native Excel.

**The Model**

I toyed around with several ideas, but ultimately decided to use the service to parse the files, hydrate an object, and insert into the database.  Then, call a web service to create reports and do the emailing based off info in the database.  The deciding factor here was that a web service is easy to deploy and other people on my team are familiar with web services and pretty much hate windows services.  Here is a class diagram of the project:

<a href="{{ site.baseurl }}/images/auctionmodel.png">![Auction Class Diagram]({{ site.baseurl }}/images/auctionmodel.png)</a>

The AuctionWatchNotify class is the wrapper called by the service "file created" method.  It hydrates the Auction class.  I've blanked out everything that would be considered proprietary here, if you had to come up with a similar system I imagine you'd get something very similar to this pretty quickly.

**Entity Framework 4.3**
After writing the code to translate the flat files to objects, the whole thing needs to be inserted into a database.  To do this manually would have taken me a considerable amount of time and a lot of redundant stored procedures that really don't do much.  So I used the newest version of my favorite [ORM](http://en.wikipedia.org/wiki/Object-relational_mapping), the Microsoft Entity Framework 4.3 with Code Migrations.  The entire model, shown above, was inserted into a database with the following code.

~~~~~~~~
public class DatabaseContext : DbContext
{
    public DbSet&lt;Auction&gt; MyAuction { get; set; }
}

using (DatabaseContext context = new DatabaseContext())
{
    context.MyAuction.Add(RunningAuction);
    context.SaveChanges();
}
~~~~~~~~

The following is the database diagram of what was generated by the Entity Framework SaveChanges() method.  
<a href="{{ site.baseurl }}/images/auctiondatabase.png">![Auction Database]({{ site.baseurl }}/images/auctiondatabase.png)</a>

I've got another post planned that will go into a little more specifics about using Migrations with the Entity Framework, but it was *fairly* painless after I got over the initial concept.  My only real regret here is that I named my DbSet "MyAuction", which made its way into the database as MyAuction_id as a foreign key column.

**FileHelpers**

I am a big fan of this product for reading and writing files, which I seem to do all the time.  The Microsoft Excel support is a little lacking but I was able to modify the source and add the functionality I needed.  Initially, I put this code in the Windows Service, but had a change of heart and moved it to the Web Server.  Well, it turns out Office automation is [not officially supported](http://support.microsoft.com/kb/257757) by Microsoft.

> *Microsoft does not currently recommend, and does not support, Automation of Microsoft Office applications from any unattended, non-interactive client application or component (including ASP, ASP.NET, DCOM, and NT Services), because Office may exhibit unstable behavior and/or deadlock when Office is run in this environment.*

Stay tuned for another post on this.  I decided to go against their recommendation because we have a significant number of users who use pre-2007 versions of excel (open XML not supported) and get confused when they get messages like "This doesn't seem to be an Excel Document, do you really want to open it?"  I paid dearly for going against their recommendation and I doubt I will ever try to get Office automation through COM working on a windows server again...ever.

**All Posts in this Series**

1.  [Introduction](http://lotsofgigs.wordpress.com/2012/08/27/windows-service-project-introduction/)
2.  [Where the project ended up](http://lotsofgigs.wordpress.com/2012/09/03/windows-service-project-where-it-ended-up/)
3.  [Entity Framework 4.3](http://lotsofgigs.wordpress.com/2012/09/10/entity-framework-4-3-code-first/)
4.  [Custom File Helpers build + creating Excel documents on windows server 2008](http://lotsofgigs.wordpress.com/2012/09/24/creating-excel-documents-on-windows-server-2008-with-custom-file-helpers-build/)
5.  <del>Problems encountered</del>
